<html>
<head>
	<meta charset="UTF-8">
	<meta name="description" content="Convert between UTM and Latitude/Longitude, using any format">
	<meta name="keywords" content="online,convert,conversion,UTM,Latitude/Longitude,latlon,lat,long,long,gps,map,location,coordinate,map coordinate">

	<link rel="stylesheet" type="text/css" href="./css/geoparse.css">
	<script src=".\js\geoclasses.js"></script>
	<script src=".\js\geoconverter.js"></script>
	<script src=".\js\geoparse.js"></script>
	<script src=".\js\norgeskart.js"></script>
	<script src=".\js\jquery-1.11.1.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
	<script src=".\js\markerwithlabel.js"></script>


</head>
<body>
<div id="divAll">
	<div id="divPanel">
		<div id="divHeader"><span class="header">EARTH</span></div>
		<div id="divInput">
			<div style="float:left;">
		    	  Enter coordinate: <input id="txtCoordinate" autofocus style="width:200px" ><!--autofocus-->  
			</div>
			<div style="float:left;">
				  <button id="btnConvertUtm" class="rounded-corners" onclick="onClickConvertUtm()">Convert UTM</button>
				  <button id="btnConvertGeo" class="rounded-corners"  onclick="onClickConvertGeo()">Convert Lat/Long</button>
			</div>
			<div id="divMyLocation" style="float:right">
					<div id="sMyLocation"></div>
					<button id="btnAddMyPos" class="rounded-corners"  onclick="onClickAddMyPos()">Add my location</button>
			</div>
		</div>
		<div id="divTable">
			 <table id="posTable">
			  		 <thead>
			  		 <!--tr><th>Label</th><th>Latitude / longitude <button class="rounded-corners" style="float:right">C</button></th><th>UTM <button class="rounded-corners" style="float:right">C</button></th></tr-->
			  		 <tr><th>Label</th><th>Latitude / logingtude</th><th>UTM</th></tr>
					 </thead>
					 <tbody>
					 </tbody>
					 <tfoot>
			  		 <tr>
					 	 <td><button id="btnClear" class="rounded-corners" onclick="onClickClearLocations()" >Clear</button> </td>
						 <td>
						 	 <select id="optDegrees" class="rounded-corners" onchange="onClickFormatChange(this, 'degrees')" >
							 		 <option value="d">d°</option>
									 <option value="dm">d°m'</option>
									 <option value="dms" selected>d°m's"</option>
							 </select>
							 <!-- ToDo: Ala http://proto.io/freebies/onoff/ -->
						 	 <div><input id="latlonOrderNE" type="checkbox" checked onchange="onClickFormatChange(this, 'degOrder')" class="rounded-corners" value="posNE">N before E</div>
						 	 <div><input id="latlonNeg" type="checkbox" onchange="onClickFormatChange(this, 'degNeg')" class="rounded-corners" value="posNE">Use negative for S and W</div>
						 </td>
						 <td>
							 <div><input id="utmOrderEN" type="checkbox" checked onchange="onClickFormatChange(this, 'utmOrder')" class="rounded-corners" value="posEN">E before N</div>
							 <div><input id="utmStrict" type="checkbox" onchange="onClickFormatChange(this, 'utmStrict')" class="rounded-corners" value="strict">Strict UTM</div>
							 <!--div>Fixed zone: <input size="2" onchange="onClickFormatChange(this, 'utmZone')" class="rounded-corners"></div-->
						 </td>
					 </tr>
					 </tfoot>
				</table>
				
		 </div>
	</div>
	<div id="divMap">
		<div id="divMap2"></div>
		<div id="divMapHeader">
			<div style="float:left;padding-right:1em;"><input id="chkMapEdit" type="checkbox" onchange="onClickMapEditChk(this)" class="rounded-corners" >Allow editing in map</div>
			<div style="float:left"><input id="chkDisplayLabels" type="checkbox" onchange="onClickDisplayLabelsChk(this)" class="rounded-corners" >Display labels in map</div>
			
			<button id="btnOpenNorgeskart" onclick="onClickOpenNorgeskart()" class="rounded-corners" style="float:right">Åpne i Norgeskart.no</button>
			<div class="clearfix"></div>
		</div>
		<div>
			<p>
			Project in progress....  
			Layout not optimized for anything but my own screen, 
			and the Norgeskart button is visible also for coordinates outside Norway. 
			</p>
			<p style="margin-bottom:0;">
			Available on <a href="https://github.com/vbakke/geoparse">https://github.com/vbakke/geoparse</a>. 
			Please report bugs to: <a href="https://github.com/vbakke/geoparse/issues">GitHub Issues</a>, or send me an <a href="mailto:geoparse@vafe.net?subject=Geoparse%20bug">email</a>.
			</p>
		</div>
	</div>
</div>
<script type="text/javascript">
	var posArray = [];
	var initZoomLevel = 2;
	var firstZoomLevel = 7;
	var config = {utm: {strict: false, orderEN: true, zone: null},
				 latlon: {format: undefined,  orderNE: true, useNeg: false},
				 map: {editInMap: false, displayLabalsInMap: true}};
	
	var myLocation = undefined; // a geoLatLon object
	var markers;
	var map;
	var clickedMapPos, tmpMapZoom;
	var tb = $("#posTable tbody");

	function initialize() {
		initMap("divMap2");
		clearLocations();
	}
	function initMap(div) {
		updateMapOptions();
		var mapOptions = {
			zoom: initZoomLevel,
			center: new google.maps.LatLng(0, 0),
			scaleControl: true,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		  };
		
		map = new google.maps.Map(document.getElementById(div), mapOptions);
		google.maps.event.addListener(map, 'click', function(event) {
			if (config.map.editInMap) {
				tmpMapZoom = map.getZoom();
				clickedMapPos = event.latLng;
				setTimeout("onClickInMap()", 600);
			}
        });

		// Get current location
		if (navigator.geolocation) {
			var span = $("#sMyLocation");
			navigator.geolocation.getCurrentPosition(function (location) {
				var lat = location.coords.latitude;
				var lon = location.coords.longitude;

				myLocation = new geoLatLon(lat, lon);

				map.setCenter(new google.maps.LatLng(lat, lon));
				map.setZoom(firstZoomLevel);
				// Display the location
				var tmp = myLocation.toString();
				span.innerText = tmp;
			});
		} 

	}
	function onClickInMap() {	
		if(tmpMapZoom == map.getZoom()){
			var posStr = clickedMapPos.lat().toFixed(5)+"N "+clickedMapPos.lng().toFixed(5)+"E";
			ga('send', 'event', 'user-click', 'addMapPos', 'addMapPos-'+posStr); // .replace(/[0-8]/g,'9'));
			ga('send', 'pageview', {
					'page': '/geoparse/addMyPos',
					'title': posStr
			});
			addLatLonLocation(clickedMapPos.lat(), clickedMapPos.lng(), undefined, true);
			clickedMapPos = null;
		}
	}
	
	function onClickConvertGeo() {
		var orgStr = $("#txtCoordinate").val();
		ga('send', 'event', 'user-click', 'convertLatLon', 'convertLatLon-'+orgStr); // .replace(/[0-8]/g,'9'));
		ga('send', 'event', 'user-click', 'convertLatLon', 'convertLatLon-'+orgStr.replace(/[0-8]/g,'9'));
		ga('send', 'pageview', {
				'page': '/geoparse/convertLatLon',
				'title': orgStr
		});
		var latlon = geoparse.parseLatLon(orgStr);
		var utm = geoconverter.LatLonToUTM(latlon);
		
		addLocation(orgStr, latlon, utm);
	}
	function onClickConvertUtm() {
		var orgStr = $("#txtCoordinate").val();
		ga('send', 'event', 'user-click', 'convertUtm', 'convertUtm-'+orgStr); // .replace(/[0-8]/g,'9'));
		ga('send', 'event', 'user-click', 'convertUtm', 'convertUtm-'+orgStr.replace(/[0-8]/g,'9'));
		ga('send', 'pageview', {
				'page': '/geoparse/convertUtm',
				'title': "orgStr"
		});
		var utm = geoparse.parseUtm(orgStr);
		var latlon = geoconverter.UTMToLatLon(utm);
		geoconverter.LatLonToUTM(latlon, utm);
		
		addLocation(orgStr, latlon, utm);
	}
	
	
	function onClickOpenNorgeskart() {
		var url = norgeskart.makeUrl(posArray, {w: $(window).width(), h: $(window).height()});
		ga('send', 'event', 'user-click', 'openKart', 'openKart-'+url);
		window.open(url);
	}
	
	function onClickMapEditChk(elem) {
		var checked = elem.checked;
		config.map.editInMap = checked;
		ga('send', 'event', 'user-click', 'changeMapConfig-EditInMap', 'changeMapConfig-EditInMap-'+checked); 

		for (var i=0; i<posArray.length; i++) {
			var location = posArray[i];
			var marker = location.marker;
			if (marker) {
				marker.set("draggable", checked);
			}
		}		
	}
	
	function onClickDisplayLabelsChk(elem) {
		var checked = elem.checked;
		config.map.displayLabalsInMap = elem.checked;
		ga('send', 'event', 'user-click', 'changeMapConfig-DisplayLabel', 'changeMapConfig-DisplayLabel-'+checked); 

		for (var i=0; i<posArray.length; i++) {
			var location = posArray[i];
			var marker = location.marker;
			if (marker) {
				marker.set("labelVisible", checked);
			}
		}
	}
	
	function onClickFormatChange(elem, type) {
		// Lat/Lon
		var vDbg;
		if (type=="degrees") {
			var val = elem.value;
			if (val == "d")
				config.latlon.format = "d° N";
			else if (val == "dm")
				config.latlon.format = "d° m' N";
			else
				config.latlon.format = "d° m' s\" N";
			vDbg = config.latlon.format;
		}
		if (type=="degOrder") {
			config.latlon.orderNE = elem.checked;
			vDbg = config.latlon.orderNE;
		}
		if (type=="degNeg") {
			config.latlon.useNeg = elem.checked;
			vDbg = config.latlon.useNeg;
		}
		// UTM
		if (type=="utmOrder") {
			config.utm.orderEN = elem.checked;
			vDbg = config.utm.orderEN;
		}
		if (type=="utmStrict") {
			config.utm.strict = elem.checked;
			vDbg = config.utm.strict;
		}
		if (type=="utmZone") {
			if (!elem.value || elem.value.trim() == "")
				config.utm.zone = null;
			else
				config.utm.zone = elem.value;
			vDbg = config.utm.zone;
		}
		ga('send', 'event', 'user-click', 'changeFormat-'+type, 'changeFormat-'+type+"-"+vDbg); 
		
		// Regenerate table
		generateTable();
	}
	
	function onClickClearLocations() {
		ga('send', 'event', 'user-click', 'clear', 'clear-'+posArray.length); 
		var btn = $("#btnAddMyPos");
		//btn.prop("disabled", false);
		clearLocations();
	}

	// Ask browser for location
	function onClickAddMyPos() {
		var span = $("#sMyLocation");
		span.innerHTML = "";
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(addMyLocation);
		} else {
			span.innerHTML = "Geolocation is not supported by this browser.";
		}
	}
	function addMyLocation(location) {
		if (location == undefined) {
			var span = $("#sMyLocation");
			span.innerHTML = "Could not retrieve your location";
		} else {
			var me = $("#btnAddMyPos");
			//me.prop("disabled", true);

			var label = "Here";
			addLatLonLocation(location.coords.latitude, location.coords.longitude, label);

			var posStr = location.coords.latitude.toFixed(5) + " N " + location.coords.longitude.toFixed(5) + " E ";
			ga('send', 'event', 'user-click', 'addMyPos', 'addMyPos-'+posStr); // .replace(/[0-8]/g,'9'));
			ga('send', 'event', 'user-click', 'addMyPos', 'addMyPos-'+posStr.replace(/[0-8]/g,'9'));
			ga('send', 'pageview', {
					'page': '/geoparse/addMyPos',
					'title': posStr
			});
		}
	}
				
	function addLatLonLocation(lat, lon, label, freezeMap) {
		//var orgStr = location.coords.latitude + " N " + location.coords.longitude + " E ";
		var latlon = new geoLatLon(lat, lon);
		var utm = geoconverter.LatLonToUTM(latlon);
		addLocation("", latlon, utm, label, freezeMap);
	}
	function updateLatLonLocation(location, newLat, newLon) {
		//var orgStr = location.coords.latitude + " N " + location.coords.longitude + " E ";
		var latlon = new geoLatLon(newLat, newLon);
		var utm = geoconverter.LatLonToUTM(latlon);
		location.orgStr = "";
		location.latlon = latlon;
		location.utm = utm;
		updateLocationInTable(tb, location);
	}
	function addLocation(orgStr, latlon, utm, label, freezeMap) {
		var labelLetters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
		if (!label) {
			label = labelLetters[posArray.length];
		}
		var location = {orgStr: orgStr, latlon: latlon, utm: utm, label: label};
		
		
		addLocationToTable(tb, location);
		addLocationToMap(location, freezeMap);
		
		posArray.push(location);
	}
	function addLocationToTable(tb, location) {
		if (posArray.length <= 0) 
			tb.empty();
		
		var str = generateTableRowStr(location);
		tb.append("<tr>"+str+"</tr>");
	}
	function updateLocationInTable(tb, location) {
		var index = posArray.indexOf(location);
		var tableRow = tb.find("tr")[index];
		var str = generateTableRowStr(location);
		tableRow.innerHTML = str;
	}
	function generateTableRowStr(location) {
		var labelStr = location.label;
		var latlonStr = location.latlon.toString(config.latlon.format, ' ', config.latlon.useNeg, config.latlon.orderNE);
		var utmStr = location.utm.toString(config.utm.strict, config.utm.orderEN, ' ');
		
		var str = "<td>"+labelStr+"</td><td>"+latlonStr+"</td><td>"+utmStr+"</td>";
		return str;
	}
	
	
	function addLocationToMap(location, freezeMap) {
		if (map == undefined)
			initMap();

		if (freezeMap == undefined) freezeMap = false;
			
		// Make a bounding box of currently visible markers 
		var data, markerPos;
		var boundingbox = new google.maps.LatLngBounds();
		var bbCount = 0;
		for (var i=0; i<posArray.length; i++) {
			data = posArray[i];
			markerPos = new google.maps.LatLng(data.latlon.lat, data.latlon.lon);
			if (map.getBounds().contains(markerPos)) {
				boundingbox.extend(markerPos);
				bbCount++;
			}
		}
		
		// Add new marker to map
		var newLat = location.latlon.lat;
		var newLon = location.latlon.lon;
		markerPos = new google.maps.LatLng(newLat, newLon);
		var markerOptions = {   map:map,
								draggable:true,
								animation: google.maps.Animation.DROP,
								position: markerPos,
								locationObj: location,
								labelContent: location.label,
								labelAnchor: new google.maps.Point(20, -1),
								labelClass: "markerlabel", // the CSS class for the label
								labelStyle: {opacity: 0.95}
		};
		var marker = new MarkerWithLabel(markerOptions);
		google.maps.event.addListener(marker, 'drag', markerDrag);
		google.maps.event.addListener(marker,'dragend', markerDragEnd);
		location.marker = marker;
		boundingbox.extend(markerPos); // Always add new marker to bounding box
		bbCount++;
		
		// Resize and zoom to boundingbox
		if (!freezeMap) {
			if (bbCount == 1) {
				if (map.getZoom() < firstZoomLevel)
					map.setZoom(firstZoomLevel);
				if (!map.getBounds().contains(markerPos))
					map.setCenter(markerPos);
			} else {
				map.fitBounds(boundingbox);
			}
		}

	}
	function markerDragEnd(event) {
		var posStr = this.position.lat().toFixed(5)+"N "+this.position.lng().toFixed(5)+"E";
		ga('send', 'event', 'user-click', 'dragTo', 'dragTo-'+posStr); // .replace(/[0-8]/g,'9'));
		updateLatLonLocation(this.locationObj, this.position.lat(), this.position.lng());
	}
	function markerDrag(event) {
		updateLatLonLocation(this.locationObj, this.position.lat(), this.position.lng());
	}
	
	function clearLocations() {
		clearLocationsFromMap();
		clearLocationsFromTable();
		posArray = [];
	}
	
	function clearLocationsFromMap() {
		for (var i=0; i<posArray.length; i++) {
			var location = posArray[i];
			if (location.marker) {
				location.marker.locationObj = null;
				location.marker.setMap(null);
				location.marker = null;
			}
		}
	}
	function clearLocationsFromTable() {
		tb.empty();
		tb.append("<tr><td></td><td><i>No coordinates added yet</td><td></td></tr>");
	}

	function generateTable() {
		if (posArray.length > 0) {
			tb.empty();
			for (var i=0; i<posArray.length; i++) {
				addLocationToTable(tb, posArray[i]);
			}
		}
	}

	function updateMapOptions() {
		$("#chkMapEdit").attr("checked", config.map.editInMap);
		$("#chkDisplayLabels").attr("checked", config.map.displayLabalsInMap);
	}
	
	function copyToClipboard(b, str) {
		alert("Str: '"+str+"'");
		
		var clip = new ClipboardEvent( 'copy' );
		clip.clipboardData.setData( 'text/plain', str);
		clip.preventDefault();
		
		b.target.dispatchEvent( clip );
		
	}

	// Add on load event to initialize the whole shebang
	google.maps.event.addDomListener(window, 'load', initialize);
</script>
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	if (document.URL.indexOf("http://localhost") > -1)
		ga('create', 'UA-6677714-4', 'auto');   // development
	else
		ga('create', 'UA-6677714-3', 'auto');   // public site
	ga('require', 'displayfeatures');
	ga('set', 'appName', 'GeoParse');
	ga('send', 'pageview');
</script>	

</body>
</html>
