<html>
<head>
	<meta charset="UTF-8">
	<!-- <META HTTP-EQUIV="Pragma" CONTENT="no-cache"> -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="Convert between UTM and Latitude/Longitude, using any format">
	<meta name="keywords" content="online,convert,conversion,UTM,Latitude/Longitude,latlon,lat,long,long,gps,map,location,coordinate,map coordinate">

	<link rel="stylesheet" type="text/css" href="./css/geoparse.css">
	<script src=".\js\geoclasses.js"></script>
	<script src=".\js\geoconverter.js"></script>
	<script src=".\js\geoparse.js"></script>
	<script src=".\js\norgeskart.js"></script>
	<script src=".\lib\jquery-1.11.1.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
	<script src=".\lib\amplify.min.js"></script>
	<script src=".\lib\markerwithlabel.js"></script>


</head>
<body>
<div id="divAll">
	<div id="divPanel">
		<div id="divHeader"><span class="header">EARTH</span></div>
		<div id="divInput">
			<div style="float:left;">
		    	  Enter coordinate: <input id="txtCoordinate" autofocus class="inputText" tabindex="1" ><!--autofocus-->  
			</div>
			<div id="divMyLocation" style="float:right">
					<div id="sMyLocation"></div>
					<button id="btnAddMyPos" class="rounded-corners"  onclick="onClickAddMyPos()" tabindex="4">Add my location</button>
			</div>
			<div style="float:left;">
				  <button id="btnConvertUtm" class="rounded-corners" onclick="onClickConvertUtm()" tabindex="2">Convert UTM</button>
				  <button id="btnConvertGeo" class="rounded-corners"  onclick="onClickConvertGeo()" tabindex="3">Convert Lat/Long</button>
			</div>
		</div>
		<div id="divTable">
			 <table id="posTable">
			  		 <thead>
			  		 <!-- <tr><th>Label</th><th>Latitude / longitude <button class="rounded-corners" style="float:right">C</button></th><th>UTM <button class="rounded-corners" style="float:right">C</button></th></tr> -->
				  		 <tr>
				  		 	<th>Label</th>
				  		 	<th>Latitude / logingtude</th>
				  		 	<th>UTM</th>
				  		 	<th><img id="hiddenImgRemoveRow" style="visibility:hidden;"></th>
			  		 	</tr>
					 </thead>
					 <tbody>
					 </tbody>
					 <tfoot>
				  		 <tr>
						 	 <td><button id="btnClear" class="rounded-corners" onclick="onClickClearLocations()" >Clear</button> </td>
							 <td>
							 	 <select id="optDegrees" class="rounded-corners" onchange="onClickFormatChange(this, 'degrees')" >
								 		 <option value="d">d°</option>
										 <option value="dm">d°m'</option>
										 <option value="dms">d°m's"</option>
								 </select>
								 <!-- ToDo: Ala http://proto.io/freebies/onoff/ -->
							 	 <div><input id="chkLatlonOrderNE" type="checkbox" onchange="onClickFormatChange(this, 'degOrder')" class="rounded-corners" value="posNE">N before E</div>
							 	 <div><input id="chkLatlonNeg" type="checkbox" onchange="onClickFormatChange(this, 'degNeg')" class="rounded-corners" value="posNE">Use negative for S and W</div>
							 </td>
							 <td>
								 <div>Fixed zone: <input size="2" onchange="onClickFormatChange(this, 'utmZone')" class="rounded-corners"></div>
								 <div><input id="chkUtmOrderEN" type="checkbox" onchange="onClickFormatChange(this, 'utmOrder')" class="rounded-corners" value="posEN">E before N</div>
								 <div><input id="chkUtmStrict" type="checkbox" onchange="onClickFormatChange(this, 'utmStrict')" class="rounded-corners" value="strict">Strict UTM</div>
							 </td>
							 <td>
							 </td>
						 </tr>
					 </tfoot>
				</table>
				
		 </div>
	</div>
	<div id="divMap">
		<div id="divMap2"></div>
		<div id="divMapHeader">
			<div style="float:left;padding-right:1em;display:"><input id="chkMapEdit" type="checkbox" onchange="onClickMapEditChk(this)" class="rounded-corners" >Allow editing in map</div>
			<div style="float:left"><input id="chkDisplayLabels" type="checkbox" onchange="onClickDisplayLabelsChk(this)" class="rounded-corners" >Display labels in map</div>
			
			<button id="btnOpenNorgeskart" onclick="onClickOpenNorgeskart()" class="rounded-corners" style="float:right">Åpne i Norgeskart.no</button>
			<div class="clearfix"></div>
		</div>
	</div>
</div>
<!-- 
<div style="clear: both"></div>
		<div id="divUsage">
			<p style="margin-bottom:0;">
			Available on <a href="https://github.com/vbakke/geoparse">https://github.com/vbakke/geoparse</a>. 
			Please report bugs to: <a href="https://github.com/vbakke/geoparse/issues">GitHub Issues</a>, or send me an <a href="mailto:geoparse@vafe.net?subject=Geoparse%20bug">email</a> if you have comments on the <a href="https://github.com/vbakke/geoparse/blob/master/ToDo%20-%20GeoParse.txt">ToDo list</a>.
			</p>
			<p>
				Cheers, :)
			</p>
		</div>
 -->
<script type="text/javascript">
	var posArray = [];
	var initZoomLevel = 2;
	var firstZoomLevel = 7;
	var latlonFormats = { d: "d° N", dm: "d° m' N", dms: "d° m' s\" N"};
	var config_default = {utm: {strict: false, orderEN: true, zone: null},
						 latlon: {format: "dms",  orderNE: true, useNeg: false},
						 map: {editInMap: false, displayLabalsInMap: true}};
	var config = amplify.store("config");
	var imgRemoveRow = "./img/red-x_16_gray.png";
	var imgRemoveRowHover = "./img/red-x_16.png";
	$("#hiddenImgRemoveRow").prop("src", imgRemoveRowHover);
	if (!config) {
		config = config_default;
		amplify.store("config", config);
	}
	updateTableOptions();
	updateMapOptions();

	var myLocation = undefined; // a geoLatLon object
	var markers;
	var map;
	var clickedMapPos, tmpMapZoom;
	var tb = $("#posTable tbody");
	var txtCoordinate = $("#txtCoordinate");

	function initialize() {
		initMap("divMap2");
		clearLocations();
	}
	function initMap(div) {
		updateMapOptions();
		var mapOptions = {
			zoom: initZoomLevel,
			center: new google.maps.LatLng(0, 0),
			scaleControl: true,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		  };
		
		map = new google.maps.Map(document.getElementById(div), mapOptions);
		google.maps.event.addListener(map, 'click', function(event) {
			if (config.map.editInMap) {
				tmpMapZoom = map.getZoom();
				clickedMapPos = event.latLng;
				setTimeout("onClickInMap()", 600);
			}
        });

		// Get current location
		if (navigator.geolocation) {
			var span = $("#sMyLocation");
			navigator.geolocation.getCurrentPosition(function (location) {
				var lat = location.coords.latitude;
				var lon = location.coords.longitude;

				myLocation = new geoLatLon(lat, lon);

				map.setCenter(new google.maps.LatLng(lat, lon));
				map.setZoom(firstZoomLevel);
				// Display the location
				var tmp = myLocation.toString();
				span.innerText = tmp;
			});
		} 

	}
	function onClickInMap() {	
		if(tmpMapZoom == map.getZoom()){
			var location = addLatLonLocation(clickedMapPos.lat(), clickedMapPos.lng(), undefined, true);
			clickedMapPos = null;

			var utmLogMsg = approxUtm(location.utm);
			ga('send', 'event', 'user-click', 'addMapPos', 'addMapPos-'+utmLogMsg); 
			ga('send', 'event', 'debug-click', 'addMapPos', 'addMapPos-'+location.utm.toString()); 
			ga('send', 'pageview', {
					'page': '/geoparse/addMyPos',
					'title': utmLogMsg
			});
		}
	}

	function onClickTableCell(elem) {
		txtCoordinate.val(elem.innerText);
		txtCoordinate.select();
	}

	function onClickConvertGeo() {
		var orgStr = txtCoordinate.val();
		ga('send', 'event', 'debug-click', 'convertLatLon', 'convertLatLon-'+orgStr); 
		ga('send', 'event', 'user-click', 'convertLatLon', 'convertLatLon-'+orgStr.replace(/[0-8]/g,'9'));
		ga('send', 'pageview', {
				'page': '/geoparse/convertLatLon',
				'title': orgStr.replace(/[0-8]/g,'9')
		});
		var latlon = geoparse.parseLatLon(orgStr);
		var utm = geoconverter.LatLonToUTM(latlon);
		
		addLocation(orgStr, latlon, utm);
	}
	function onClickConvertUtm() {
		var orgStr = txtCoordinate.val();
		ga('send', 'event', 'debug-click', 'convertUtm', 'convertUtm-'+orgStr); // .replace(/[0-8]/g,'9'));
		ga('send', 'event', 'user-click', 'convertUtm', 'convertUtm-'+orgStr.replace(/[0-8]/g,'9'));
		ga('send', 'pageview', {
				'page': '/geoparse/convertUtm',
				'title': orgStr.replace(/[0-8]/g,'9')
		});
		var utm = geoparse.parseUtm(orgStr);
		var latlon = geoconverter.UTMToLatLon(utm);
		geoconverter.LatLonToUTM(latlon, utm);
		
		addLocation(orgStr, latlon, utm);
	}
	
	
	function onClickOpenNorgeskart() {
		var url = norgeskart.makeUrl(posArray, {w: $(window).width(), h: $(window).height()});
		ga('send', 'event', 'debug-click', 'openKart', 'openKart-'+url);
		ga('send', 'event', 'user-click', 'openKart', 'openKart');
		window.open(url);
	}
	
	function onClickMapEditChk(elem) {
		var checked = elem.checked;
		config.map.editInMap = checked;
		amplify.store('config', config);
		ga('send', 'event', 'user-click', 'changeMapConfig-EditInMap', 'changeMapConfig-EditInMap-'+checked); 

		for (var i=0; i<posArray.length; i++) {
			var location = posArray[i];
			var marker = location.marker;
			if (marker) {
				marker.set("draggable", checked);
			}
		}		
	}
	
	function onClickDisplayLabelsChk(elem) {
		var checked = elem.checked;
		config.map.displayLabalsInMap = elem.checked;
		amplify.store('config', config);
		ga('send', 'event', 'user-click', 'changeMapConfig-DisplayLabel', 'changeMapConfig-DisplayLabel-'+checked); 

		for (var i=0; i<posArray.length; i++) {
			var location = posArray[i];
			var marker = location.marker;
			if (marker) {
				marker.set("labelVisible", checked);
			}
		}
	}
	
	function onClickFormatChange(elem, type) {
		// Lat/Lon
		var vDbg;
		if (type=="degrees") {
			config.latlon.format = elem.value;
			vDbg = config.latlon.format;
		}
		if (type=="degOrder") {
			config.latlon.orderNE = elem.checked;
			vDbg = config.latlon.orderNE;
		}
		if (type=="degNeg") {
			config.latlon.useNeg = elem.checked;
			vDbg = config.latlon.useNeg;
		}
		// UTM
		if (type=="utmOrder") {
			config.utm.orderEN = elem.checked;
			vDbg = config.utm.orderEN;
		}
		if (type=="utmStrict") {
			config.utm.strict = elem.checked;
			vDbg = config.utm.strict;
		}
		if (type=="utmZone") {
			var orgZone = config.utm.zone;
			if (!elem.value || elem.value.trim() == "" || parseInt(elem.value)==NaN)
				config.utm.zone = null;
			else
				config.utm.zone = parseInt(elem.value);
			vDbg = config.utm.zone;
			if (orgZone != config.utm.zone)
				regenerateUtm(config.utm.zone);
		}

		amplify.store('config', config);

		ga('send', 'event', 'user-click', 'changeFormat-'+type, 'changeFormat-'+type+"-"+vDbg); 
		
		// Regenerate table
		generateTable();
	}
	
	function onClickClearLocations() {
		ga('send', 'event', 'user-click', 'clear', 'clear-'+posArray.length); 
		var btn = $("#btnAddMyPos");
		//btn.prop("disabled", false);
		clearLocations();
	}

	function onClickRemoveRow(elem) {
		var index = tb.index(elem.parentNode.parentNode);
		var tr = $(elem).closest("tr");
		var tdUtm = tr.find("td").eq(2);

		txtCoordinate.val(tdUtm.text());

		index = tr.index();
		removeLocation(index);

		ga('send', 'event', 'user-click', 'removeRow', 'removeRow-'+index); 
	}

	// Ask browser for location
	function onClickAddMyPos() {
		var span = $("#sMyLocation");
		span.innerHTML = "";
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(addMyLocation);
		} else {
			span.innerHTML = "Geolocation is not supported by this browser.";
		}
	}
	function addMyLocation(pos) {
		if (pos == undefined) {
			var span = $("#sMyLocation");
			span.innerHTML = "Could not retrieve your location";
		} else {
			var me = $("#btnAddMyPos");
			//me.prop("disabled", true);

			var label = "Here";
			var location = addLatLonLocation(pos.coords.latitude, pos.coords.longitude, label);

			var utmLogMsg = approxUtm(location.utm);
			ga('send', 'event', 'user-click', 'addMyPos', 'addMyPos-'+utmLogMsg); 
			ga('send', 'event', 'debug-click', 'addMyPos', 'addMyPos-'+location.utm.toString());
			ga('send', 'pageview', {
					'page': '/geoparse/addMyPos',
					'title': utmLogMsg
			});
		}
	}
				
	function addLatLonLocation(lat, lon, label, freezeMap) {
		//var orgStr = location.coords.latitude + " N " + location.coords.longitude + " E ";
		var latlon = new geoLatLon(lat, lon);
		var utm = geoconverter.LatLonToUTM(latlon);
		var location = addLocation("", latlon, utm, label, freezeMap);
		return location;
	}

	function updateLatLonLocation(location, newLat, newLon) {
		//var orgStr = location.coords.latitude + " N " + location.coords.longitude + " E ";
		var latlon = new geoLatLon(newLat, newLon);
		var utm = geoconverter.LatLonToUTM(latlon);
		location.orgStr = "";
		location.latlon = latlon;
		location.utm = utm;
		updateLocationInTable(tb, location);
	}
	function addLocation(orgStr, latlon, utm, label, freezeMap) {
		var labelLetters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
		if (!label) {
			label = labelLetters[posArray.length];
		}
		var location = {orgStr: orgStr, latlon: latlon, utm: utm, label: label};
		
		
		addLocationToTable(tb, location);
		addLocationToMap(location, freezeMap);
		
		posArray.push(location);
		
		return location;
	}
	function addLocationToTable(tb, location) {
		if (posArray.length <= 0) 
			tb.empty();

		var index = posArray.length;
		var str = generateTableRowStr(index, location);
		tb.append("<tr>"+str+"</tr>");
	}
	function updateLocationInTable(tb, location) {
		var index = posArray.indexOf(location);
		var tableRow = tb.find("tr")[index];
		var str = generateTableRowStr(index, location);
		tableRow.innerHTML = str;
	}
	function generateTableRowStr(index, location) {
		var labelStr = location.label;
		var format = latlonFormats[config.latlon.format];
		var latlonStr = location.latlon.toString(format, ' ', config.latlon.useNeg, config.latlon.orderNE);
		var utmStr = location.utm.toString(config.utm.strict, config.utm.orderEN, ' ');
		
		var str = "<td>"+labelStr+"</td>" + 
					"<td onclick=\"onClickTableCell(this)\">"+latlonStr+"</td>" +
					"<td  onclick=\"onClickTableCell(this)\">"+utmStr+"</td>" +
					'<td><img src="'+imgRemoveRow+'" hover-src="'+imgRemoveRowHover+'" onmouseover="imgSwap(this)" onmouseout="imgSwap(this)"   onclick="onClickRemoveRow(this)"></td>';
		return str;
	}
	
	
	function addLocationToMap(location, freezeMap) {
		if (map == undefined)
			initMap();

		if (freezeMap == undefined) freezeMap = false;
			
		// Make a bounding box of currently visible markers 
		var data, markerPos;
		var boundingbox = new google.maps.LatLngBounds();
		var bbCount = 0;
		for (var i=0; i<posArray.length; i++) {
			data = posArray[i];
			markerPos = new google.maps.LatLng(data.latlon.lat, data.latlon.lon);
			if (map.getBounds().contains(markerPos)) {
				boundingbox.extend(markerPos);
				bbCount++;
			}
		}
		
		// Add new marker to map
		var newLat = location.latlon.lat;
		var newLon = location.latlon.lon;
		markerPos = new google.maps.LatLng(newLat, newLon);
		var markerOptions = {   map:map,
								draggable:config.map.editInMap,
								animation: google.maps.Animation.DROP,
								position: markerPos,
								locationObj: location,
								labelContent: location.label,
								labelAnchor: new google.maps.Point(20, -1),
								labelClass: "markerlabel", // the CSS class for the label
								labelStyle: {opacity: 0.95}
		};
		var marker = new MarkerWithLabel(markerOptions);
		google.maps.event.addListener(marker, 'drag', markerDrag);
		google.maps.event.addListener(marker,'dragend', markerDragEnd);
		location.marker = marker;
		boundingbox.extend(markerPos); // Always add new marker to bounding box
		bbCount++;
		
		// Resize and zoom to boundingbox
		if (!freezeMap) {
			if (bbCount == 1) {
				if (map.getZoom() < firstZoomLevel)
					map.setZoom(firstZoomLevel);
				if (!map.getBounds().contains(markerPos))
					map.setCenter(markerPos);
			} else {
				map.fitBounds(boundingbox);
			}
		}

	}
	function markerDragEnd(event) {
		var posStr = this.position.lat().toFixed(5)+"N "+this.position.lng().toFixed(5)+"E";
		ga('send', 'event', 'user-click', 'dragTo', 'dragTo-'+posStr); // .replace(/[0-8]/g,'9'));
		updateLatLonLocation(this.locationObj, this.position.lat(), this.position.lng());
	}
	function markerDrag(event) {
		updateLatLonLocation(this.locationObj, this.position.lat(), this.position.lng());
	}
	
	function clearLocations() {
		clearLocationsFromMap();
		clearLocationsFromTable();
		posArray = [];
	}
	
	function removeLocation(index) {
		removeLocationFromMap(index);
		removeLocationFromTable(index);
		posArray.splice(index, 1); // Remove the element
	}
	
	function clearLocationsFromMap() {
		for (var i=0; i<posArray.length; i++) {
			removeLocationFromMap(i);
		}
	}

	function removeLocationFromMap(index) {		
		var location = posArray[index];
		if (location.marker) {
			location.marker.locationObj = null;
			location.marker.setMap(null);
			location.marker = null;
		}
	}
	

	function clearLocationsFromTable() {
		tb.empty();
		addToTableNoElelemntsText();
	}

	function removeLocationFromTable(index) {
		var tr = tb.find("tr").eq(index);

		tr.remove();

		if (tb.children().length == 0)
			addToTableNoElelemntsText();
	}

	function addToTableNoElelemntsText() {
		tb.append("<tr><td></td><td><i>No coordinates added yet</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td></td></tr>");
	}

	function regenerateUtm(zone) {
		for (var i=0; i<posArray.length; i++) {
			var location = posArray[i];
			var utmNew = geoconverter.LatLonToUTM(location.latlon, undefined, zone);
			location.utm = utmNew;
		}
	}

	function generateTable() {
		if (posArray.length > 0) {
			tb.empty();
			for (var i=0; i<posArray.length; i++) {
				addLocationToTable(tb, posArray[i]);
			}
		}
	}

	function updateTableOptions() {
		var s = '#optDegrees option[value='+config.latlon.format+']';
		var o = $(s);
		//o.prop('selected', true);
		$('#optDegrees option[value='+config.latlon.format+']').prop('selected', true);
		$("#chkLatlonNeg").attr("checked", config.latlon.useNeg);
		$("#chkLatlonOrderNE").attr("checked", config.latlon.orderNE);
		$("#chkUtmStrict").attr("checked", config.utm.strict);
		$("#chkUtmOrderEN").attr("checked", config.utm.orderEN);
	}

	function updateMapOptions() {
		$("#chkMapEdit").attr("checked", config.map.editInMap);
		$("#chkDisplayLabels").attr("checked", config.map.displayLabalsInMap);
	}


	function approxUtm(utm) {
		var round = 1000; //  in meters
		var str = utm.zone + utm.band + " " + Math.floor(utm.easting/round)*round + "E " + Math.floor(utm.northing/round)*round + "N";
		return str;
	}


	function imgSwap(elem) {
		$(elem).attr({
				'src':        $(elem).attr('hover-src'), 
				'hover-src':  $(elem).attr('src') 
		});
	}
	
	function copyToClipboard(b, str) {
		alert("Str: '"+str+"'");
		
		var clip = new ClipboardEvent( 'copy' );
		clip.clipboardData.setData( 'text/plain', str);
		clip.preventDefault();
		
		b.target.dispatchEvent( clip );
		
	}

	// Add on load event to initialize the whole shebang
	google.maps.event.addDomListener(window, 'load', initialize);
</script>
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	if (document.URL.indexOf("http://localhost") > -1)
		ga('create', 'UA-6677714-4', 'auto');   // development
	else
		ga('create', 'UA-6677714-3', 'auto');   // public site
	ga('require', 'displayfeatures');
	ga('set', 'appName', 'GeoParse');
	ga('send', 'pageview');
</script>	

</body>
</html>
